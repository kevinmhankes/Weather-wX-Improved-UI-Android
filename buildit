#!/bin/bash
#export NDK_TOOLCHAIN_VERSION=clang 
#export PATH=~/android-studio/jre/bin:$PATH
APP_NAME=wX
dropBoxPath=${HOME}/Dropbox/wX/
dateString=$(date '+%Y_%m_%d_%H_%M')
gitRepo="https://gitlab.com/joshua.tee/wx.git"
ver=$(grep versionName app/src/main/AndroidManifest.xml |awk -F'"'  '{print $2}')

echo Compile release
export PATH=/Applications/"Android Studio.app"/Contents/jre/jdk/Contents/Home/bin:~/android-studio/jre/bin:$PATH
./gradlew assembleRelease
cp app/build/outputs/apk/release/app-release.apk $APP_NAME.apk 
cp $APP_NAME.apk ~/StudioProjects/wX${ver}.apk

#cd ~
#./scr.wx
#cd ~/StudioProjects/wX

echo Git commit and push
touch doc/ChangeLog.txt
git commit -a -m "release ${ver} commit ${dateString}"
git push

# needed for f-droid
if [ "$1" == "-t" ]; then
	echo Git tag for fdroid
	git tag ${ver}
	git push origin --tags
fi

echo Clone and zip
mkdir ${tmpPath} || exit 1
cd ${tmpPath} || exit 1
git clone ${gitRepo}
zip -r $APP_NAME${ver}.zip $APP_NAME -x *.git* > /dev/null
ls -l $APP_NAME${ver}.zip 
#cp $APP_NAME${ver}.zip ${dropBoxPath}/
cp $APP_NAME${ver}.zip ~/StudioProjects/
rm -r ${tmpPath} 

echo Copy to Storage
cd ${HOME}/StudioProjects
cp wX${ver}.apk ${dropBoxPath}
cp $APP_NAME${ver}.zip  ${dropBoxPath}
